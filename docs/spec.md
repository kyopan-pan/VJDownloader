# VJDownloader 仕様

## 概要
- クリップボードのURLから動画をダウンロードし、ローカルのMP4を管理・送出するmacOS向けツール。
- UIはダーク基調で、ダウンロード進捗と保存済みリストを表示する。
- アプリ名は「VJ Downloader (Rust)」で表示される。

## ウィンドウ
- 初期サイズは幅420px・高さ720px。
- 最小サイズは幅360px・高さ640px。

## 保存先と設定
- 既定の保存先は`~/Movies/YtDlpDownloads`。
- 設定ファイルは`~/.vjdownloader/settings.properties`。
- 設定キー`download.dir`が存在し空でない場合、その値を保存先として使用する。
- 設定ファイルは`#`または`!`で始まる行をコメントとして無視する。
- 設定ファイルは`key=value`または`key:value`形式の行のみを読む。

## 初回セットアップ画面
- yt-dlpまたはDenoが未導入・実行不可の場合に初回セットアップ画面を表示する。
- 初回セットアップ画面は独立したウィンドウとして表示する。
- 初回セットアップ画面でyt-dlp/Denoの状態とバージョンを表示する。
- `自動セットアップ`でyt-dlp/Denoを取得し、完了後に状態を更新する。

## 設定画面
- `Cmd+,`でも設定画面を開ける。
- macOSのメニューバー（Appメニュー）から`設定...`を開ける。
- `Cmd+L`またはmacOSのメニューバー（Appメニュー）`ログ...`でログ画面を開ける。
- 設定画面は独立したウィンドウとして表示する。
- 出力先フォルダ、YouTube認証（ブラウザクッキー）の設定を編集できる。
- 出力先フォルダはボタンからmacOSのフォルダ選択UIで指定できる。
- クッキー利用時はブラウザ名が必須で、未入力の場合は保存できない。
- 保存時に出力先フォルダが存在しない場合は作成を試みる。
- yt-dlp/Denoのバージョンとステータスを表示し、`最新を取得`で再取得できる。

## クッキー設定
- 設定キー`cookies.from_browser.enabled`が`true`のときのみクッキー取得を有効化する。
- 設定キー`cookies.from_browser.browser`が空の場合はクッキー取得を無効扱いとする。
- 設定キー`cookies.from_browser.profile`が空でない場合は`browser:profile`形式を使用する。
- クッキー取得はyt-dlpの`--cookies-from-browser`オプションとして渡す。

## 内部パス
- アプリ用データは`~/.ytdownloader`配下を使用する。
- `~/.ytdownloader/bin`にツール用のバイナリを配置する。
- yt-dlpは`~/.ytdownloader/bin/yt-dlp`に保存する。
- ffmpegは`~/.ytdownloader/bin/ffmpeg`を参照する。
- ffprobeは`~/.ytdownloader/bin/ffprobe`を参照する。
- denoは`~/.ytdownloader/bin/deno`を参照する。

## ダウンロード開始
- ダウンロード開始はクリップボードの文字列をそのままURLとして利用する。
- クリップボードに文字列がない、または空の場合は何もしない。

## ダウンロード処理
- ダウンロードは別スレッドで実行する。
- 起動時にバックグラウンドでyt-dlp/denoの有無を確認し、未導入ならGitHubの最新リリースから取得する。
- yt-dlpをダウンロードした後、実行権限を付与する。
- ffmpeg/ffprobeは同梱バイナリから`~/.vjdownloader/bin`へコピーし、実行権限を付与する。
- denoが存在しない場合はGitHubの最新リリースから`deno-aarch64-apple-darwin.zip`をダウンロードし展開する。
- yt-dlpが実行可能でない場合はダウンロードを開始しない。
- 保存先フォルダが存在しない場合は作成する。
- 出力テンプレートは`%(title)s.%(ext)s`を使用する。
- yt-dlp実行時に`~/.vjdownloader/bin`をPATH先頭に追加する。
- yt-dlpのstdout/stderrは行単位で読み取り、ログと進捗に反映する。
- ダウンロード中にStopを押した場合は実行中のプロセスを終了してキャンセルする。

## ダウンロードオプション（優先モード）
- `--no-playlist`を指定する。
- `--extractor-args youtube:player_client=web`を指定する。
- `--extractor-args youtube:skip=translated_subs`を指定する。
- `--concurrent-fragments 4`を指定する。
- `-S vcodec:h264,res,acodec:m4a`を指定する。
- `--match-filter vcodec~='(?i)^(avc|h264)'`を指定する。
- `--merge-output-format mp4`と`--ffmpeg-location`を指定する。
- `--js-runtimes deno`を指定する。
- 優先モードが失敗した場合は互換モードで再試行する。

## ダウンロードオプション（互換モード）
- `--no-playlist`を指定する。
- `--extractor-args youtube:player_client=web`を指定する。
- `--extractor-args youtube:skip=translated_subs`を指定する。
- `--concurrent-fragments 4`を指定する。
- `-f bv*[height<=720]+ba/b[height<=720]`を指定する。
- `--recode-video mp4`を指定する。
- `--postprocessor-args VideoConvertor:-c:v h264_videotoolbox -b:v 5M -pix_fmt yuv420p`を指定する。
- `--ffmpeg-location`を指定する。
- `--js-runtimes deno`を指定する。

## AnimeThemes専用パイプライン
- URLに`animethemes.moe`を含む場合に専用パイプラインへ分岐する。
- ファイル名はURLパスを基にした`.mp4`（タイムスタンプ付き）を使用する。
- URL解析・API/HTML確認中は進捗メッセージに`動画情報確認中・・・`を表示する。
- パイプラインは`リンク取得 -> 直リンク(webm)ダウンロード -> ffmpeg変換(mp4)`の順で実行する。
- 直リンク取得（優先）: `AnimeThemes API`（`/anime/<slug>?include=animethemes.animethemeentries.videos`）を優先し、必要に応じて`/anime?filter[slug]=<slug>&include=...`も試行する。
- APIレスポンスはJSON:API形式（`included` + `relationships`）と従来のネスト形式の両方に対応し、`theme.slug/type+sequence -> animethemeentries -> videos -> link`を辿って`.webm`を抽出する。
- APIで取得できない場合はHTML解析へフォールバックし、`curl -sL -m 8 -A <UA> --range 0-262143`で先頭を取得して`og:video`または`video src`から`https://.../*.webm`を抽出する。見つからない場合は全文取得で再試行する。
- 直リンクを取得できた場合は一時`.webm`へ保存し、`Content-Length`と転送量からダウンロード進捗（`n%`）を算出して表示する。
- ダウンロード進捗は進捗バーだけでなくログにも`ダウンロード進捗: n%`として出力する。
- ffmpeg変換は`h264_videotoolbox`を必須とし、利用できない場合は処理を中断する。
- ffmpeg変換時は`ffprobe`で入力動画の長さを取得し、`ffmpeg`ログの`time=`進捗から変換進捗（`変換中... n%`）を進捗バーへ反映する。
- ffmpeg変換ログは整形せずデフォルト出力をそのままステータスログへ出力する。
- 直リンク取得に失敗した場合は`yt-dlp --no-playlist --concurrent-fragments 4 -f "bv+ba/b" --ffmpeg-location <ffmpeg> -o - <ページURL>`の出力をffmpegへパイプする。
- ffmpegは`-stats -analyzeduration 100M -probesize 100M -c:v h264_videotoolbox -b:v 5M -pix_fmt yuv420p -c:a aac -b:a 192k -ignore_unknown -movflags +faststart -f mp4 -y <出力パス>`を基本とし、直リンク経路では`-i <一時webm>`、yt-dlpフォールバック経路では`-f webm -i pipe:0`を使用する。

## 進捗表示
- 進捗パネルは常に表示され、待機中は半透明表示となる。
- 進捗メッセージの初期値は`待機中...`。
- ダウンロード開始直後は`動画読み込み中...`を表示する。
- 進捗率が取得できる場合は`ダウンロード中... xx.x%`を表示する。
- 変換や結合が始まった場合は`変換中...`を表示する。
- 完了時は`ダウンロード完了!`を表示する。
- 完了後1.2秒で進捗表示を非表示(待機状態)に戻す。
- 進捗率が不明な場合はインジケータをアニメーション表示する。

## 進捗の判定
- yt-dlp出力に`[merger]`や`[ffmpeg]`などの語が出現した場合は変換フェーズと判定する。
- yt-dlp出力中の`%`表記から進捗率を抽出する。進捗率が100%でも変換中には切り替えない。

## ファイル一覧
- 保存先フォルダ内の`.mp4`のみを表示する。
- 一覧は最終更新日時の降順で並べる。
- 一覧の表示高は360pxで固定する。
- リストが空の場合は`まだダウンロードがありません。`を表示する。
- 行右端の`✕`ボタンで削除できる。
- ファイル名は左寄せで表示する。
- ファイル名の上下パディングは等間隔に揃える。
- ファイル名が長い場合は末尾を`...`で省略する。

## Drag & Drop
- リスト項目のドラッグでmacOSネイティブのファイルドラッグを開始する。
- Finderと同様に、ドラッグ中はファイルアイコンが表示される。
- ドロップ先へはファイル参照が渡る。
- ファイル名を含むホバーでハイライトされる範囲全体がドラッグ対象。
- ホバー時はマウスカーソルをポインタ表示に変更する。
- クリック等の動作は不要（ドラッグ専用）。
- ドラッグ開始時はファイルパスを正規化し、失敗時はステータスにエラーを表示する。
- ドラッグ用アイコンはFinder同様にmacOSのファイルアイコンを使用し、過大表示しないサイズで表示する。

## カーソル挙動
- メイン/設定/ログの全ウィンドウで、クリックまたはドラッグ可能な要素はホバー時にポインタ表示とする。
- 検索欄や設定のテキスト入力欄はI-beamカーソルを維持する。
- フォーカス喪失中およびフォーカス復帰直後もカーソル追従を維持する（OS制約内のベストエフォート）。

## ログ画面
- ログはメモリ上に最大1000件保持し、各行は`[HH:mm:ss] メッセージ`形式で記録する。
- ログ画面は独立ウィンドウ（初期サイズ760x460、最小520x280）で表示する。
- ログ一覧は下方向にスクロール可能で、常に最新行が末尾に表示される。
- ログ画面には`アプリを終了するとログはクリアされます。`の案内を表示する。
- `表示をクリア`ボタンでログ一覧を全削除する。
- `直近10分をコピー`ボタンで直近10分のログをクリップボードへコピーする。
- ログはアプリ終了時にクリアされる（永続化しない）。
- macOSでは入力ソース変更を監視し、日本語入力に切り替わった場合は`日本語になりました`、英字入力（ABC）に切り替わった場合は`英字になりました`をログ出力する。

## UIテキスト
- メインボタンの表示は待機時`Download`、ダウンロード中は`Stop`。
- サブタイトルに`リストをドラッグしてVDMXへドロップ`を表示する。
- ダウンロード中もメインボタンは有効で、クリックするとキャンセルする。

## テーマとフォント
- ダークテーマを適用する。
- ベース背景色は`rgb(12, 18, 32)`を使用する。
- 主要なアクセントカラーは`rgb(16, 190, 255)`を使用する。
- ボタンやパネルは角丸を使用する。
- フォントはSF系フォントを優先し、無い場合はAvenir系を使用する。
- 日本語フォントはHiragino Sans等のシステムフォントから順に使用する。

## エラーハンドリング
- 保存先作成失敗時はダウンロードを中断し、エラーを表示する。
- yt-dlp起動失敗時はダウンロード失敗として扱う。
- ファイル削除失敗時はステータスに`削除に失敗しました: <error>`を表示する。
- ドラッグ開始失敗時はステータスにエラーを表示する。

## mp4検索インデックス（SQLite）
- mp4検索は`~/.ytdownloader/search_index.sqlite3`のSQLiteインデックスを使用する。
- `roots`テーブルで検索対象ルートフォルダを管理し、`files`テーブルでmp4ファイル情報を管理する。
- `files`には`path`（PK）、`root_id`、`file_name`、`file_name_norm`、`parent_dir`、`size_bytes`、`modified_time`、`created_time`、`last_indexed_time`を保持する。
- `roots`には`root_id`（PK）、`root_path`、`is_enabled`、`last_scan_time`を保持する。
- `files.root_id`、`files.parent_dir`、`files.file_name_norm`、`files.modified_time`、`files.size_bytes`にインデックスを作成する。

## 検索対象フォルダ設定
- 設定キー`search.roots`に検索対象ルートフォルダ（複数）を保存する。
- 設定画面から検索対象フォルダを追加・削除できる。
- 設定保存時に検索対象ルートをDBへ同期し、新規追加ルートはバックグラウンドでフルスキャンする。
- 設定画面の`全体を再インデックス`で全ルートを再スキャンできる。

## 検索仕様（インデックス検索）
- 検索はインデックス方式で行い、検索時にフォルダ全体のフルスキャンは行わない。
- クエリは`file_name_norm`に対して部分一致検索を行う。
- 非空クエリでは2段階検索を行う。
- 第1段階は前方一致（`query%`）で検索し、足りない場合に第2段階の部分一致（`%query%`）で補完する。
- `%`と`_`を含むクエリはLIKEエスケープしてリテラルとして扱う。
- クエリが空の場合は更新日時降順、非空の場合は名前順で返す。
- メタデータ条件として`root_id/root_path`、`parent_dir`、`modified_time`範囲、`size_bytes`範囲、`limit`、`sort`を検索APIで受け付ける。

## 検索UI
- 検索結果はダウンロード一覧と同じ行UIで表示し、表示内容はファイル名のみとする。
- 検索結果行には削除ボタンを表示しない。
- 検索結果行のドラッグでmacOSネイティブのファイルドラッグを開始し、VDMXへドロップできる。
- 検索クエリが空のときは、結果リスト内に何も表示しない。
- ヒット0件時はリスト枠内に`該当するファイルはありませんでした`を表示する。
- 検索入力中の選択ハイライトは強い青色を使わず、目立たない配色にする。

## 日本語検索の扱い
- 検索用正規化はNFKC + 小文字化（英字吸収）を適用する。
- 正規化は`src/search_index.rs`の`normalize_for_search`で実装する。
- 日本語の表記ゆれ（互換文字・結合文字）をある程度吸収するが、意味的同義語や読み仮名変換は対象外。

## 監視更新とフォールバック
- `notify`による再帰監視でルート配下の差分を取り込み、DBを更新する。
- 監視イベントはデバウンス（700ms）してまとめて処理する。
- renameは旧パス削除＋新パス追加として処理する。
- deleteはファイル削除またはディレクトリ配下削除として処理する。
- 監視エラー発生時はフォールバックとして有効ルートの再スキャンを行う。

## 並行処理とDBアクセス
- SQLite書き込みは単一ライタースレッド（キュー経由）に集約する。
- 検索は別スレッドで実行し、入力連打時は最新クエリを優先して古い要求を破棄する。
- DBはWALモードを使用し、検索と更新の並行実行時の待ちを低減する。

## 実装デフォルト値と変更方法
- 検索正規化方式: `normalize_for_search`（NFKC + lower）
- 監視デバウンス: `DEBOUNCE_WINDOW`（700ms）
- バッチupsert件数: `UPSERT_BATCH_SIZE`（256）
- 最大検索件数: `MAX_SEARCH_LIMIT`（1000）
- これらは`src/search_index.rs`内の定数または関数を変更することで調整できる。
