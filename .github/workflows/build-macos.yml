name: Build macOS (自動ビルド)

on:
  # main ブランチへの push で自動ビルド
  push:
    branches: [ "main" ]
  # GitHub 画面から手動実行
  workflow_dispatch:

jobs:
  build:
    strategy:
      matrix:
        # YtDownloader と同じ運用に合わせた macOS マトリクス
        os: [ macos-14, macos-15, macos-26 ]
        include:
          - os: macos-14
            arch: aarch64
          - os: macos-15
            arch: aarch64
          - os: macos-26
            arch: aarch64

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout code (ソース取得)
        uses: actions/checkout@v4

      # Rust ツールチェーンをセットアップ
      - name: Set up Rust (Rust環境準備)
        uses: dtolnay/rust-toolchain@stable

      # Cargo のビルドキャッシュを利用して高速化
      - name: Cache Cargo build (キャッシュ復元)
        uses: Swatinem/rust-cache@v2

      # Cargo.toml の version を取り出し、後続ステップで再利用
      - name: Extract version from Cargo.toml (バージョン取得)
        run: |
          APP_VERSION=$(grep -m1 '^version = ' Cargo.toml | cut -d '"' -f2)
          echo "APP_VERSION=${APP_VERSION}" >> "${GITHUB_ENV}"
          echo "Detected version: ${APP_VERSION}"

      # リリース用バイナリをビルド
      - name: Build release binary (リリースビルド)
        run: cargo build --release --locked

      # YtDownloader由来のSVGアイコンを macOS 用 .icns に変換
      - name: Build app icon from YtDownloader SVG (アイコン生成)
        run: |
          if ! command -v rsvg-convert >/dev/null 2>&1; then
            brew install librsvg
          fi

          mkdir -p dist/icon.iconset
          rsvg-convert -w 1024 -h 1024 assets/icon/ytdownloader-download.svg -o dist/icon-1024.png

          for size in 16 32 128 256 512; do
            sips -z "${size}" "${size}" dist/icon-1024.png --out "dist/icon.iconset/icon_${size}x${size}.png" >/dev/null
            sips -z "$((size * 2))" "$((size * 2))" dist/icon-1024.png --out "dist/icon.iconset/icon_${size}x${size}@2x.png" >/dev/null
          done

          iconutil -c icns dist/icon.iconset -o dist/AppIcon.icns

      # Finder から直接起動できる .app バンドルを作成（Terminalを経由しない）
      - name: Create .app bundle (macOSアプリ化)
        run: |
          mkdir -p dist
          APP_DIR="dist/VJDownloader.app"
          mkdir -p "${APP_DIR}/Contents/MacOS"
          mkdir -p "${APP_DIR}/Contents/Resources"
          cp target/release/VJDownloader "${APP_DIR}/Contents/MacOS/VJDownloader"
          cp dist/AppIcon.icns "${APP_DIR}/Contents/Resources/AppIcon.icns"
          chmod +x "${APP_DIR}/Contents/MacOS/VJDownloader"

          cat > "${APP_DIR}/Contents/Info.plist" << 'PLIST'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>CFBundleDevelopmentRegion</key>
            <string>ja</string>
            <key>CFBundleDisplayName</key>
            <string>VJDownloader</string>
            <key>CFBundleExecutable</key>
            <string>VJDownloader</string>
            <key>CFBundleIconFile</key>
            <string>AppIcon.icns</string>
            <key>CFBundleIdentifier</key>
            <string>com.kyopan.vjdownloader</string>
            <key>CFBundleInfoDictionaryVersion</key>
            <string>6.0</string>
            <key>CFBundleName</key>
            <string>VJDownloader</string>
            <key>CFBundlePackageType</key>
            <string>APPL</string>
            <key>CFBundleShortVersionString</key>
            <string>${{ env.APP_VERSION }}</string>
            <key>CFBundleVersion</key>
            <string>${{ github.run_number }}</string>
            <key>LSMinimumSystemVersion</key>
            <string>13.0</string>
            <key>NSHighResolutionCapable</key>
            <true/>
          </dict>
          </plist>
          PLIST

      # 署名用証明書を一時キーチェーンへ取り込み（未設定時はスキップ）
      - name: Import signing certificate (任意)
        env:
          MACOS_CERT_P12_BASE64: ${{ secrets.MACOS_CERT_P12_BASE64 }}
          MACOS_CERT_P12_PASSWORD: ${{ secrets.MACOS_CERT_P12_PASSWORD }}
        run: |
          if [ -z "${MACOS_CERT_P12_BASE64}" ] || [ -z "${MACOS_CERT_P12_PASSWORD}" ]; then
            echo "Signing certificate secrets are not set. Skip import."
            exit 0
          fi

          KEYCHAIN_PATH="${RUNNER_TEMP}/app-signing.keychain-db"
          KEYCHAIN_PASSWORD="$(openssl rand -base64 24)"

          echo "${MACOS_CERT_P12_BASE64}" | (base64 --decode 2>/dev/null || base64 -D) > "${RUNNER_TEMP}/cert.p12"

          security create-keychain -p "${KEYCHAIN_PASSWORD}" "${KEYCHAIN_PATH}"
          security set-keychain-settings -lut 21600 "${KEYCHAIN_PATH}"
          security unlock-keychain -p "${KEYCHAIN_PASSWORD}" "${KEYCHAIN_PATH}"
          security import "${RUNNER_TEMP}/cert.p12" -k "${KEYCHAIN_PATH}" -P "${MACOS_CERT_P12_PASSWORD}" -T /usr/bin/codesign -T /usr/bin/security
          security list-keychains -d user -s "${KEYCHAIN_PATH}"
          security set-key-partition-list -S apple-tool:,apple:,codesign: -k "${KEYCHAIN_PASSWORD}" "${KEYCHAIN_PATH}"

      # .app を Developer ID 署名（未設定時はスキップ）
      - name: Sign .app (任意)
        env:
          MACOS_CERT_IDENTITY: ${{ secrets.MACOS_CERT_IDENTITY }}
        run: |
          if [ -z "${MACOS_CERT_IDENTITY}" ]; then
            echo "Signing identity is not set. Skip app signing."
            exit 0
          fi

          codesign --force --deep --options runtime --timestamp --sign "${MACOS_CERT_IDENTITY}" "dist/VJDownloader.app"
          codesign --verify --deep --strict --verbose=2 "dist/VJDownloader.app"

      # Applications へドラッグする想定の DMG を作成
      - name: Create DMG artifact (DMG作成)
        run: |
          DMG_ROOT="dist/dmg-root"
          DMG_PATH="dist/VJDownloader-${{ env.APP_VERSION }}-${{ matrix.os }}.dmg"

          rm -rf "${DMG_ROOT}"
          mkdir -p "${DMG_ROOT}"
          cp -R "dist/VJDownloader.app" "${DMG_ROOT}/VJDownloader.app"
          ln -s /Applications "${DMG_ROOT}/Applications"

          hdiutil create -volname "VJDownloader" -srcfolder "${DMG_ROOT}" -ov -format UDZO "${DMG_PATH}"

      # DMG に署名（未設定時はスキップ）
      - name: Sign DMG (任意)
        env:
          MACOS_CERT_IDENTITY: ${{ secrets.MACOS_CERT_IDENTITY }}
        run: |
          if [ -z "${MACOS_CERT_IDENTITY}" ]; then
            echo "Signing identity is not set. Skip dmg signing."
            exit 0
          fi

          codesign --force --timestamp --sign "${MACOS_CERT_IDENTITY}" "dist/VJDownloader-${{ env.APP_VERSION }}-${{ matrix.os }}.dmg"
          codesign --verify --verbose=2 "dist/VJDownloader-${{ env.APP_VERSION }}-${{ matrix.os }}.dmg"

      # Apple Notary で公証し、チケットを付与（未設定時はスキップ）
      - name: Notarize and staple DMG (任意)
        env:
          MACOS_CERT_IDENTITY: ${{ secrets.MACOS_CERT_IDENTITY }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          if [ -z "${MACOS_CERT_IDENTITY}" ] || [ -z "${APPLE_ID}" ] || [ -z "${APPLE_APP_SPECIFIC_PASSWORD}" ] || [ -z "${APPLE_TEAM_ID}" ]; then
            echo "Signing/notarization secrets are not set. Skip notarization."
            exit 0
          fi

          DMG_PATH="dist/VJDownloader-${{ env.APP_VERSION }}-${{ matrix.os }}.dmg"

          xcrun notarytool submit "${DMG_PATH}" --apple-id "${APPLE_ID}" --password "${APPLE_APP_SPECIFIC_PASSWORD}" --team-id "${APPLE_TEAM_ID}" --wait
          xcrun stapler staple "${DMG_PATH}"
          spctl -a -vv -t open "${DMG_PATH}"

      # DMG を成果物としてアップロード
      - name: Upload build artifact (成果物アップロード)
        uses: actions/upload-artifact@v4
        with:
          name: VJDownloader-${{ env.APP_VERSION }}-${{ matrix.os }}
          path: dist/VJDownloader-${{ env.APP_VERSION }}-${{ matrix.os }}.dmg

      # 参考用に .app の ZIP も残す（未署名の場合は警告回避できない）
      - name: Create ZIP artifact (参考用ZIP)
        run: |
          cd dist
          zip -r "VJDownloader-${{ env.APP_VERSION }}-${{ matrix.os }}.zip" VJDownloader.app

      # ZIP も成果物としてアップロード
      - name: Upload ZIP artifact (参考用アップロード)
        uses: actions/upload-artifact@v4
        with:
          name: VJDownloader-${{ env.APP_VERSION }}-${{ matrix.os }}-zip
          path: dist/VJDownloader-${{ env.APP_VERSION }}-${{ matrix.os }}.zip
