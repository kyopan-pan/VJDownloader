name: Build macOS (自動ビルド)

on:
  # main ブランチへの push で自動ビルド
  push:
    branches: [ "main" ]
  # GitHub 画面から手動実行
  workflow_dispatch:

jobs:
  build:
    strategy:
      matrix:
        # YtDownloader と同じ運用に合わせた macOS マトリクス
        os: [ macos-14, macos-15, macos-26 ]
        include:
          - os: macos-14
            arch: aarch64
          - os: macos-15
            arch: aarch64
          - os: macos-26
            arch: aarch64

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout code (ソース取得)
        uses: actions/checkout@v4

      # Rust ツールチェーンをセットアップ
      - name: Set up Rust (Rust環境準備)
        uses: dtolnay/rust-toolchain@stable

      # Cargo のビルドキャッシュを利用して高速化
      - name: Cache Cargo build (キャッシュ復元)
        uses: Swatinem/rust-cache@v2

      # Cargo.toml の version を取り出し、後続ステップで再利用
      - name: Extract version from Cargo.toml (バージョン取得)
        run: |
          APP_VERSION=$(grep -m1 '^version = ' Cargo.toml | cut -d '"' -f2)
          echo "APP_VERSION=${APP_VERSION}" >> "${GITHUB_ENV}"
          echo "Detected version: ${APP_VERSION}"

      # リリース用バイナリをビルド
      - name: Build release binary (リリースビルド)
        run: cargo build --release --locked

      # YtDownloader由来のSVGアイコンを macOS 用 .icns に変換
      - name: Build app icon from YtDownloader SVG (アイコン生成)
        run: |
          if ! command -v rsvg-convert >/dev/null 2>&1; then
            brew install librsvg
          fi

          mkdir -p dist/icon.iconset
          rsvg-convert -w 1024 -h 1024 assets/icon/ytdownloader-download.svg -o dist/icon-1024.png

          for size in 16 32 128 256 512; do
            sips -z "${size}" "${size}" dist/icon-1024.png --out "dist/icon.iconset/icon_${size}x${size}.png" >/dev/null
            sips -z "$((size * 2))" "$((size * 2))" dist/icon-1024.png --out "dist/icon.iconset/icon_${size}x${size}@2x.png" >/dev/null
          done

          iconutil -c icns dist/icon.iconset -o dist/AppIcon.icns

      # Finder から直接起動できる .app バンドルを作成（Terminalを経由しない）
      - name: Create .app bundle (macOSアプリ化)
        run: |
          mkdir -p dist
          APP_DIR="dist/VJDownloader.app"
          mkdir -p "${APP_DIR}/Contents/MacOS"
          mkdir -p "${APP_DIR}/Contents/Resources"
          cp target/release/VJDownloader "${APP_DIR}/Contents/MacOS/VJDownloader"
          cp dist/AppIcon.icns "${APP_DIR}/Contents/Resources/AppIcon.icns"
          chmod +x "${APP_DIR}/Contents/MacOS/VJDownloader"

          cat > "${APP_DIR}/Contents/Info.plist" << 'PLIST'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>CFBundleDevelopmentRegion</key>
            <string>ja</string>
            <key>CFBundleDisplayName</key>
            <string>VJDownloader</string>
            <key>CFBundleExecutable</key>
            <string>VJDownloader</string>
            <key>CFBundleIconFile</key>
            <string>AppIcon.icns</string>
            <key>CFBundleIdentifier</key>
            <string>com.kyopan.vjdownloader</string>
            <key>CFBundleInfoDictionaryVersion</key>
            <string>6.0</string>
            <key>CFBundleName</key>
            <string>VJDownloader</string>
            <key>CFBundlePackageType</key>
            <string>APPL</string>
            <key>CFBundleShortVersionString</key>
            <string>${{ env.APP_VERSION }}</string>
            <key>CFBundleVersion</key>
            <string>${{ github.run_number }}</string>
            <key>LSMinimumSystemVersion</key>
            <string>13.0</string>
            <key>NSHighResolutionCapable</key>
            <true/>
          </dict>
          </plist>
          PLIST

      # 公証なし運用でも「壊れている」判定を避けるため ad-hoc 署名を付与
      - name: Ad-hoc sign .app (Gatekeeper対策)
        run: |
          xattr -cr "dist/VJDownloader.app"
          codesign --force --deep --sign - "dist/VJDownloader.app"
          codesign --verify --deep --strict --verbose=2 "dist/VJDownloader.app"

      # create-dmg で Applications へドラッグするレイアウト付き DMG を作成
      - name: Create DMG artifact (create-dmg)
        run: |
          if ! command -v create-dmg >/dev/null 2>&1; then
            brew install create-dmg
          fi

          DMG_SRC="dist/dmg-src"
          DMG_PATH="dist/VJDownloader-${{ env.APP_VERSION }}-${{ matrix.os }}.dmg"

          rm -rf "${DMG_SRC}" "${DMG_PATH}"
          mkdir -p "${DMG_SRC}"
          cp -R "dist/VJDownloader.app" "${DMG_SRC}/VJDownloader.app"

          create-dmg \
            --format UDZO \
            --volname "VJDownloader" \
            --window-size 820 520 \
            --icon-size 160 \
            --icon "VJDownloader.app" 220 250 \
            --hide-extension "VJDownloader.app" \
            --app-drop-link 600 250 \
            "${DMG_PATH}" \
            "${DMG_SRC}"

      # DMG を成果物としてアップロード
      - name: Upload build artifact (成果物アップロード)
        uses: actions/upload-artifact@v4
        with:
          name: VJDownloader-${{ env.APP_VERSION }}-${{ matrix.os }}
          path: dist/VJDownloader-${{ env.APP_VERSION }}-${{ matrix.os }}.dmg
